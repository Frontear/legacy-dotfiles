#!/bin/sh

DEVICES="/sys/class/backlight"

case $1 in
    # TODO: custom monitor format output
    -m | --monitor)
        # TODO: ignore first few lines from udevadm monitor
        udevadm monitor -ks backlight | while read; do
            find $DEVICES -type l | while read BACKLIGHT; do
                CUR_LEVEL="$(cat $BACKLIGHT/brightness)"
                MAX_LEVEL="$(cat $BACKLIGHT/max_brightness)"

                awk "BEGIN {print ($CUR_LEVEL / $MAX_LEVEL) * 100}"
            done
        done
        ;;
    -i | --increase)
        find $DEVICES -type l | while read BACKLIGHT; do
            CUR_LEVEL="$(cat $BACKLIGHT/brightness)"
            MAX_LEVEL="$(cat $BACKLIGHT/max_brightness)"

            NEW_LEVEL=$(awk "BEGIN {print $CUR_LEVEL + ($MAX_LEVEL * ${2:-0.05})}")
            if [ $NEW_LEVEL -lt $MAX_LEVEL ]; then
                echo $NEW_LEVEL > $BACKLIGHT/brightness
            else
                echo $MAX_LEVEL > $BACKLIGHT/brightness
            fi
        done
        ;;
    -d | --decrease)
        find $DEVICES -type l | while read BACKLIGHT; do
            CUR_LEVEL="$(cat $BACKLIGHT/brightness)"
            MAX_LEVEL="$(cat $BACKLIGHT/max_brightness)"

            NEW_LEVEL=$(awk "BEGIN {print $CUR_LEVEL - ($MAX_LEVEL * ${2:-0.05})}")
            if [ $NEW_LEVEL -gt 0 ]; then
                echo $NEW_LEVEL > $BACKLIGHT/brightness
            else
                echo 0 > $BACKLIGHT/brightness
            fi
        done
        ;;
esac
